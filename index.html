<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Aloca√ß√µes</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

    <header>
        <h1>Painel de Aloca√ß√µes da Equipe</h1>
    </header>

    <div class="actions-bar">
        <button id="add-button">Adicionar Aloca√ß√£o</button>
    </div>

    <main>
        <div class="tabela-container">
            <div id="loader" class="loader-overlay">
                <div class="spinner"></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Recurso</th>
                        <th>Escopo</th>
                        <th>Fase</th>
                        <th>Tipo de Aloca√ß√£o</th>
                        <th>Orienta√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela">
                    </tbody>
            </table>
        </div>
    </main>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Aloca√ß√£o</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="add-form">
                <input type="hidden" id="edit-id">

                <div class="form-group">
                    <label for="Data">Data</label>
                    <input type="date" id="Data" required>
                </div>
                <div class="form-group">
                    <label for="ID_Recurso">Recurso</label>
                    <select id="ID_Recurso" required></select>
                </div>
                <div class="form-group">
                    <label for="ID_Escopo">Escopo</label>
                    <select id="ID_Escopo" required></select>
                </div>
                <div class="form-group">
                    <label for="Fase">Fase</label>
                    <select id="Fase" required></select>
                </div>
                <div class="form-group">
                    <label for="TipoAlocacao">Tipo de Aloca√ß√£o</label>
                    <select id="TipoAlocacao" required></select>
                </div>
                <div class="form-group">
                    <label for="SubTipoAlocacao">Sub-Tipo de Aloca√ß√£o</label>
                    <select id="SubTipoAlocacao" required></select>
                </div>
                <div class="form-group">
                    <label for="Orientacao">Orienta√ß√£o</label>
                    <select id="Orientacao" required></select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- C√ìDIGO JAVASCRIPT FINAL COM EDI√á√ÉO ---
        const API_URL = 'COLE_A_SUA_URL_AQUI'; // <-- IMPORTANTE: COLOQUE SUA URL AQUI

        document.addEventListener('DOMContentLoaded', () => {
            // Elementos do DOM
            const corpoTabela = document.getElementById('corpo-tabela');
            const modal = document.getElementById('add-modal');
            const modalTitle = modal.querySelector('.modal-header h2');
            const addButton = document.getElementById('add-button');
            const closeButton = modal.querySelector('.close-button');
            const addForm = document.getElementById('add-form');
            const editIdInput = document.getElementById('edit-id');
            const loader = document.getElementById('loader');

            // Estado global para guardar os dados carregados
            let alocacoesCache = [];
            let recursosCache = [];
            let escoposCache = [];

            // Fun√ß√µes do Modal
            const abrirModal = () => modal.style.display = 'flex';
            const fecharModal = () => {
                modal.style.display = 'none';
                addForm.reset();
                editIdInput.value = '';
                modalTitle.textContent = 'Nova Aloca√ß√£o';
            }

            // Fun√ß√£o para mostrar notifica√ß√µes
            const showToast = (message, type = 'info') => {
                 const colors = { success: 'linear-gradient(to right, #00b09b, #96c93d)', error: 'linear-gradient(to right, #ff5f6d, #ffc371)', info: 'linear-gradient(to right, #4a6cf7, #63b3ed)' };
                 Toastify({ text: message, duration: 3000, close: true, gravity: "top", position: "right", stopOnFocus: true, style: { background: colors[type] || colors.info }, }).showToast();
             };

            // Fun√ß√£o principal para carregar dados
            async function carregarDados() {
                if (loader) loader.style.display = 'flex';
                corpoTabela.innerHTML = ''; // Limpa a tabela antes de carregar
                try {
                    const [resAlocacoes, resRecursos, resEscopos] = await Promise.all([
                        fetch(API_URL + '?action=getAlocacoes'),
                        fetch(API_URL + '?action=getRecursos'),
                        fetch(API_URL + '?action=getEscopos')
                    ]);
                    // Verifica se as respostas foram bem sucedidas antes de converter para JSON
                    if (!resAlocacoes.ok || !resRecursos.ok || !resEscopos.ok) {
                         throw new Error('Falha ao buscar dados da API.');
                    }
                    alocacoesCache = await resAlocacoes.json();
                    recursosCache = await resRecursos.json();
                    escoposCache = await resEscopos.json();
                    renderizarTabela(alocacoesCache, recursosCache, escoposCache);
                    // Popula dropdowns fixos apenas uma vez (os din√¢micos s√£o populados ao abrir o modal)
                    popularDropdownsFixos();
                } catch (error) {
                    corpoTabela.innerHTML = `<tr><td colspan="7">Erro ao carregar os dados: ${error.message}</td></tr>`;
                    showToast(`Erro ao carregar dados: ${error.message}`, 'error');
                } finally {
                    if (loader) loader.style.display = 'none';
                }
            }

            // Fun√ß√£o para renderizar a tabela
            function renderizarTabela(alocacoes, recursos, escopos) {
                const recursosMap = new Map(recursos.map(r => [r.ID_Recurso, r.NomeRecurso]));
                const escoposMap = new Map(escopos.map(e => [e.ID_Escopo, e.NomeEscopo]));
                corpoTabela.innerHTML = ''; // Garante que a tabela esteja limpa
                if (!Array.isArray(alocacoes) || alocacoes.length === 0) {
                     corpoTabela.innerHTML = '<tr><td colspan="7">Nenhuma aloca√ß√£o encontrada.</td></tr>';
                     return;
                }
                alocacoes.forEach(alocacao => {
                    if (!alocacao || !alocacao.Data) return;
                    const dataFormatada = new Date(alocacao.Data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    corpoTabela.innerHTML += `
                        <tr data-alocacao-id="${alocacao.ID_Alocacao}">
                            <td>${dataFormatada}</td>
                            <td>${recursosMap.get(alocacao.ID_Recurso) || ''}</td>
                            <td>${escoposMap.get(alocacao.ID_Escopo) || ''}</td>
                            <td>${alocacao.Fase || ''}</td>
                            <td>${alocacao.TipoAlocacao || ''}</td>
                            <td>${alocacao.Orientacao || ''}</td>
                            <td>
                                <button class="edit-btn" data-id="${alocacao.ID_Alocacao}">‚úèÔ∏è</button>
                                <button class="delete-btn" data-id="${alocacao.ID_Alocacao}">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            }

            // Fun√ß√£o para popular dropdowns fixos (executada uma vez)
            function popularDropdownsFixos() {
                const selectFase = document.getElementById('Fase');
                const selectTipoAlocacao = document.getElementById('TipoAlocacao');
                const selectSubTipo = document.getElementById('SubTipoAlocacao');
                const selectOrientacao = document.getElementById('Orientacao');
                const fases = ["Implanta√ß√£o", "Ongoing", "Piloto", "Produto"];
                const tiposAlocacao = ["Cobertura", "Lista", "Revis√£o", "Desagrupamento", "Homologa√ß√£o Prosa"];
                const subTipos = ["Excel", "Sistema"];
                const orientacoes = ["Homologa√ß√£o Normal", "Desagrupamento", "Melhoria de AP", "Revis√£o"];
                const preencherSelect = (el, opts, ph) => { el.innerHTML = `<option value="">${ph}</option>`; opts.forEach(o => el.innerHTML += `<option value="${o}">${o}</option>`); };
                preencherSelect(selectFase, fases, "Selecione uma Fase");
                preencherSelect(selectTipoAlocacao, tiposAlocacao, "Selecione um Tipo");
                preencherSelect(selectSubTipo, subTipos, "Selecione um Sub-Tipo");
                preencherSelect(selectOrientacao, orientacoes, "Selecione uma Orienta√ß√£o");
            }
            
            // Fun√ß√£o para popular dropdowns DIN√ÇMICOS (executada ao abrir modal)
            function popularDropdownsDinamicos(modoEdicao = false, idAlocacaoAtual = null) {
                const selectRecurso = document.getElementById('ID_Recurso');
                const selectEscopo = document.getElementById('ID_Escopo');

                // Filtra recursos dispon√≠veis APENAS se estivermos adicionando
                let recursosParaDropdown = recursosCache;
                if (!modoEdicao) {
                    const recursosUsados = new Set(alocacoesCache.map(a => a.ID_Recurso));
                    recursosParaDropdown = recursosCache.filter(r => !recursosUsados.has(r.ID_Recurso));
                } else {
                     // Se editando, mostra todos, mas permite manter o atual mesmo se j√° usado por outro
                     const alocacaoAtual = alocacoesCache.find(a => a.ID_Alocacao == idAlocacaoAtual);
                     const idRecursoAtual = alocacaoAtual ? alocacaoAtual.ID_Recurso : null;
                     const recursosUsadosPorOutros = new Set(alocacoesCache.filter(a => a.ID_Alocacao != idAlocacaoAtual).map(a => a.ID_Recurso));
                     recursosParaDropdown = recursosCache.filter(r => !recursosUsadosPorOutros.has(r.ID_Recurso) || r.ID_Recurso == idRecursoAtual);
                }

                selectRecurso.innerHTML = '<option value="">Selecione um Recurso</option>';
                recursosParaDropdown.forEach(r => selectRecurso.innerHTML += `<option value="${r.ID_Recurso}">${r.NomeRecurso}</option>`);

                selectEscopo.innerHTML = '<option value="">Selecione um Escopo</option>';
                escoposCache.forEach(e => selectEscopo.innerHTML += `<option value="${e.ID_Escopo}">${e.NomeEscopo}</option>`);
            }

            // Fun√ß√£o para abrir o modal para edi√ß√£o
            function abrirModalParaEditar(id) {
                const alocacaoParaEditar = alocacoesCache.find(a => a.ID_Alocacao == id);
                if (!alocacaoParaEditar) { showToast('Erro: Aloca√ß√£o n√£o encontrada.', 'error'); return; }
                
                popularDropdownsDinamicos(true, id); // Popula dropdowns din√¢micos em modo de edi√ß√£o

                editIdInput.value = alocacaoParaEditar.ID_Alocacao;
                const dataObjeto = new Date(alocacaoParaEditar.Data);
                const ano = dataObjeto.getUTCFullYear();
                const mes = String(dataObjeto.getUTCMonth() + 1).padStart(2, '0');
                const dia = String(dataObjeto.getUTCDate()).padStart(2, '0');
                document.getElementById('Data').value = `${ano}-${mes}-${dia}`;
                document.getElementById('ID_Recurso').value = alocacaoParaEditar.ID_Recurso;
                document.getElementById('ID_Escopo').value = alocacaoParaEditar.ID_Escopo;
                document.getElementById('Fase').value = alocacaoParaEditar.Fase;
                document.getElementById('TipoAlocacao').value = alocacaoParaEditar.TipoAlocacao;
                document.getElementById('SubTipoAlocacao').value = alocacaoParaEditar.SubTipoAlocacao;
                document.getElementById('Orientacao').value = alocacaoParaEditar.Orientacao;

                modalTitle.textContent = 'Editar Aloca√ß√£o';
                abrirModal();
            }

            // Fun√ß√£o para deletar
            async function deletarAlocacaoPeloId(id) {
                if (!confirm('Tem certeza que deseja deletar esta aloca√ß√£o?')) { return; }
                try {
                    showToast('Deletando aloca√ß√£o...', 'info');
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'delete', ID_Alocacao: id })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast('Aloca√ß√£o deletada!', 'success');
                        carregarDados();
                    } else { showToast('Erro ao deletar: ' + result.message, 'error'); }
                } catch (error) { showToast('Erro de conex√£o ao deletar.', 'error'); }
            }

            // Configura√ß√£o dos Eventos
            addButton.addEventListener('click', () => {
                popularDropdownsDinamicos(false); // Popula dropdowns din√¢micos em modo de adi√ß√£o
                abrirModal();
            });
            closeButton.addEventListener('click', fecharModal);
            window.addEventListener('click', (e) => { if (e.target == modal) fecharModal(); });

            corpoTabela.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.getAttribute('data-id');
                if (target.classList.contains('edit-btn')) {
                    abrirModalParaEditar(id);
                } else if (target.classList.contains('delete-btn')) {
                    deletarAlocacaoPeloId(id);
                }
            });

            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const idParaEditar = editIdInput.value;
                const formData = {
                    Data: document.getElementById('Data').value, ID_Recurso: document.getElementById('ID_Recurso').value,
                    ID_Escopo: document.getElementById('ID_Escopo').value, Fase: document.getElementById('Fase').value,
                    TipoAlocacao: document.getElementById('TipoAlocacao').value, SubTipoAlocacao: document.getElementById('SubTipoAlocacao').value,
                    Orientacao: document.getElementById('Orientacao').value
                };
                let action = '';
                let toastMessage = 'Salvando nova aloca√ß√£o...';
                if (idParaEditar) {
                    action = 'update';
                    formData.ID_Alocacao = idParaEditar;
                    toastMessage = 'Atualizando aloca√ß√£o...';
                }
                try {
                    showToast(toastMessage, 'info');
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(action ? { ...formData, action: action } : formData)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast(idParaEditar ? 'Aloca√ß√£o atualizada!' : 'Aloca√ß√£o salva!', 'success');
                        fecharModal();
                        carregarDados();
                    } else { showToast('Erro: ' + result.message, 'error'); }
                } catch (error) { showToast('Erro de conex√£o.', 'error'); }
            });

            // Inicia tudo
            carregarDados();
        });
    </script>

</body>
</html>